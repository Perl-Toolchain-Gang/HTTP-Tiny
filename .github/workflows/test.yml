name: Test
on:
  push: ~
  pull_request: ~

jobs:
  perl-images:
    runs-on: ubuntu-latest
    name: Calculate Perl Images
    outputs:
      images: ${{ toJSON(fromJSON(steps.perl-images.outputs.result).images) }}
      last-image: ${{ fromJSON(steps.perl-images.outputs.result).last-image }}
    steps:
      - uses: actions/checkout@v4
      - id: perl-versions
        uses: perl-actions/perl-versions@v1
        with:
          since-perl: v5.14
          with-devel: true
      - id: perl-images
        uses: actions/github-script@v7
        env:
          PERL_VERSIONS: ${{ steps.perl-versions.outputs.perl-versions }}
        with:
          script: |
            const perl_versions = JSON.parse(process.env.PERL_VERSIONS);
            const images = perl_versions.map((v) => {
              const res = v.match(/^5\.(\d+)$/);
              let suffix = '';
              if (res) {
                const [, minor] = res;
                if (minor < 26) {
                  suffix = '-buster';
                }
              }
              return `perl:${v}${suffix}`;
            });
            return {
              images,
              'last-image': images.findLast(i => i.match(/^perl:5/)),
            };

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/cache@v4
        with:
          path: ~/.perl-cpm
          key: cpm-${{ runner.os }}
      - name: Setup local::lib
        run: |
          echo "$RUNNER_TEMP/perl5/bin" >> "$GITHUB_PATH"
          echo "PERL5LIB=$RUNNER_TEMP/perl5/lib/perl5:$PERL5LIB" >> "$GITHUB_ENV"
          echo "PERL_MB_OPT=--install_base $RUNNER_TEMP/perl5" >> "$GITHUB_ENV"
          echo "PERL_MM_OPT=INSTALL_BASE=$RUNNER_TEMP/perl5" >> "$GITHUB_ENV"
      - name: Extract Dist::Zilla dependencies
        id: authordeps
        uses: perl-actions/get-prereqs@v1
        with:
          sources: dist.ini
          phases: author
      - name: Install authordeps
        uses: perl-actions/install-with-cpm@v1
        with:
          sudo: false
          install: ${{ steps.authordeps.outputs.prereqs }}
      - name: Build
        id: build
        run: |
          DZIL_COLOR=1 dzil build --no-tgz | tee "/tmp/dzil-build.log"
          echo build="$(grep --only-matching 'built in .*' "/tmp/dzil-build.log" | tail -1 | cut -c10-)" >> "$GITHUB_OUTPUT"
      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.build }}
          path: ${{ steps.build.outputs.build }}
          include-hidden-files: true
    outputs:
      name: ${{ steps.build.outputs.build }}

  test:
    needs:
      - perl-images
      - build

    strategy:
      fail-fast: false
      matrix:
        image: ${{ fromJSON(needs.perl-images.outputs.images) }}

    runs-on: ubuntu-latest
    container:
      image: ${{ matrix.image }}

    env:
      AUTOMATED_TESTING: 1
      PERL_USE_UNSAFE_INC: 0

    steps:
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.name }}
      - uses: actions/cache@v4
        with:
          path: ~/.perl-cpm
          key: cpm-${{ matrix.image }}
      - name: Setup local::lib
        run: |
          echo "$RUNNER_TEMP/perl5/bin" >> "$GITHUB_PATH"
          echo "PERL5LIB=$RUNNER_TEMP/perl5/lib/perl5:$PERL5LIB" >> "$GITHUB_ENV"
          echo "PERL_MB_OPT=--install_base $RUNNER_TEMP/perl5" >> "$GITHUB_ENV"
          echo "PERL_MM_OPT=INSTALL_BASE=$RUNNER_TEMP/perl5" >> "$GITHUB_ENV"
      - name: Extract configure dependecies
        id: configure
        uses: perl-actions/get-prereqs@v1
        with:
          phases: configure
      - name: Install configure deps
        uses: perl-actions/install-with-cpm@v1
        with:
          sudo: false
          install: ${{ steps.configure.outputs.prereqs }}
      - name: Run Makefile.PL
        run: perl Makefile.PL
      - name: Extract dependecies
        id: prereqs
        uses: perl-actions/get-prereqs@v1
        with:
          phases: build test runtime
          relationships: requires recommends suggests
          exclude: |
            ^lib$
      - name: Install deps
        uses: perl-actions/install-with-cpm@v1
        with:
          sudo: false
          install: ${{ steps.prereqs.outputs.prereqs }}
      - name: Run the tests
        run: make test
        env:
          AUTHOR_TESTING: 1

  test-xt:
    needs:
      - perl-images
      - build

    runs-on: ubuntu-latest
    container:
      image: ${{ needs.perl-images.outputs.last-image }}

    env:
      AUTOMATED_TESTING: 1

    steps:
      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.name }}
      - uses: actions/cache@v4
        with:
          path: ~/.perl-cpm
          key: cpm-${{ matrix.image }}
      - name: Setup local::lib
        run: |
          echo "$RUNNER_TEMP/perl5/bin" >> "$GITHUB_PATH"
          echo "PERL5LIB=$RUNNER_TEMP/perl5/lib/perl5:$PERL5LIB" >> "$GITHUB_ENV"
          echo "PERL_MB_OPT=--install_base $RUNNER_TEMP/perl5" >> "$GITHUB_ENV"
          echo "PERL_MM_OPT=INSTALL_BASE=$RUNNER_TEMP/perl5" >> "$GITHUB_ENV"
      - name: Extract configure dependecies
        id: configure
        uses: perl-actions/get-prereqs@v1
        with:
          phases: configure
      - name: Install configure deps
        uses: perl-actions/install-with-cpm@v1
        with:
          sudo: false
          install: ${{ steps.configure.outputs.prereqs }}
      - name: Run Makefile.PL
        run: perl Makefile.PL
      - name: Extract dependecies
        id: prereqs
        uses: perl-actions/get-prereqs@v1
        with:
          phases: build test runtime develop
          relationships: requires recommends suggests
          exclude: |
            ^lib$
      - name: Install deps
        uses: perl-actions/install-with-cpm@v1
        with:
          sudo: false
          install: ${{ steps.prereqs.outputs.prereqs }}
      - name: Run the xt tests
        run: prove -l xt
        env:
          AUTHOR_TESTING: 1
      - name: Run the xt/author tests
        run: prove -lr xt/author
        env:
          AUTHOR_TESTING: 1
